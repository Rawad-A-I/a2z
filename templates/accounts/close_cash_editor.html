{% extends 'base/base.html' %}
{% load static %}

{% block title %}Edit {{ display_name }} - Close Cash{% endblock %}

{% block start %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-file-excel text-warning me-2"></i>
                        {{ display_name }}
                        {% if is_master %}
                            <span class="badge bg-warning text-dark ms-2">Master Analytics</span>
                        {% endif %}
                    </h2>
                    <p class="text-muted mb-0">
                        Last modified: {{ last_modified|date:"M d, Y H:i" }} | 
                        Size: {{ file_size|filesizeformat }}
                    </p>
                </div>
                <div>
                    <a href="{% url 'close_cash_dashboard' %}" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                    </a>
                    <a href="{% url 'download_excel_file' filename %}" class="btn btn-outline-primary">
                        <i class="fas fa-download me-2"></i>Download
                    </a>
                </div>
            </div>

            <!-- Warning Alert -->
            <div class="alert alert-warning mb-4">
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle fa-2x me-3 text-warning"></i>
                    <div>
                        <h6 class="mb-1"><strong>Excel-like Editor</strong></h6>
                        <ul class="mb-0">
                            <li>Use keyboard shortcuts: Ctrl+C (copy), Ctrl+V (paste), Ctrl+Z (undo)</li>
                            <li>Arrow keys to navigate, Tab to move right, Enter to move down</li>
                            <li>Changes are saved automatically every 30 seconds</li>
                            <li>For complex edits, download the file and upload it back</li>
                            {% if is_master %}
                                <li><strong>Master File:</strong> This file contains INDIRECT formulas that reference other sheets</li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Save Status -->
            <div id="saveStatus" class="alert alert-info mb-3" style="display: none;">
                <i class="fas fa-spinner fa-spin me-2"></i>
                <span id="saveMessage">Saving changes...</span>
            </div>

            <!-- Excel Spreadsheet Container -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-table me-2"></i>Excel Spreadsheet</h5>
                    <div>
                        <button id="saveBtn" class="btn btn-success" disabled>
                            <i class="fas fa-save me-2"></i>Save Changes
                        </button>
                        <button id="resetBtn" class="btn btn-outline-secondary ms-2">
                            <i class="fas fa-undo me-2"></i>Reset
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="spreadsheet-container" style="height: 70vh; width: 100%;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- jspreadsheet CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jspreadsheet@latest/dist/jspreadsheet.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jspreadsheet@latest/dist/jspreadsheet.theme.css">

<!-- jspreadsheet JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/jspreadsheet@latest/dist/jspreadsheet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspreadsheet@latest/dist/jspreadsheet.umd.js"></script>

<style>
#spreadsheet-container {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
}

.jexcel_container {
    border: none !important;
}

.jexcel_container table {
    border-collapse: separate !important;
    border-spacing: 0 !important;
}

.jexcel_container td {
    border: 1px solid #d1d5db !important;
    padding: 4px 8px !important;
    font-size: 13px !important;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
}

.jexcel_container td.selected {
    background-color: #007bff !important;
    color: white !important;
}

.jexcel_container td:hover {
    background-color: #f8f9fa !important;
}

.jexcel_container th {
    background-color: #f8f9fa !important;
    border: 1px solid #d1d5db !important;
    font-weight: 600 !important;
    text-align: center !important;
    padding: 8px 4px !important;
}

#saveStatus {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    min-width: 300px;
}

.btn:disabled {
    opacity: 0.6;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Excel data from Django
    const excelData = {{ excel_data|safe }};
    const maxRow = {{ max_row }};
    const maxCol = {{ max_col }};
    
    // Convert Django data to jspreadsheet format
    const spreadsheetData = [];
    for (let row = 0; row < maxRow; row++) {
        const rowData = [];
        for (let col = 0; col < maxCol; col++) {
            if (excelData[row] && excelData[row][col]) {
                const cell = excelData[row][col];
                // Show formula if present, otherwise show value
                rowData.push(cell.formula || cell.value || '');
            } else {
                rowData.push('');
            }
        }
        spreadsheetData.push(rowData);
    }
    
    // Initialize jspreadsheet
    const spreadsheet = jspreadsheet(document.getElementById('spreadsheet-container'), {
        data: spreadsheetData,
        columns: maxCol,
        rows: maxRow,
        allowInsertRow: false,
        allowInsertColumn: false,
        allowDeleteRow: false,
        allowDeleteColumn: false,
        allowRenameColumn: false,
        allowComments: false,
        allowSort: false,
        allowExport: false,
        allowImport: false,
        allowCopy: true,
        allowPaste: true,
        allowUndo: true,
        allowRedo: true,
        allowInsert: true,
        allowDelete: true,
        allowMove: true,
        allowResize: true,
        allowSelect: true,
        allowEdit: true,
        allowInsertRow: false,
        allowInsertColumn: false,
        allowDeleteRow: false,
        allowDeleteColumn: false,
        allowRenameColumn: false,
        allowComments: false,
        allowSort: false,
        allowExport: false,
        allowImport: false,
        allowCopy: true,
        allowPaste: true,
        allowUndo: true,
        allowRedo: true,
        allowInsert: true,
        allowDelete: true,
        allowMove: true,
        allowResize: true,
        allowSelect: true,
        allowEdit: true,
        tableOverflow: true,
        tableHeight: '70vh',
        tableWidth: '100%',
        wordWrap: false,
        columnResize: true,
        rowResize: true,
        columnSorting: false,
        columnDrag: false,
        rowDrag: false,
        contextMenu: true,
        toolbar: true,
        search: true,
        pagination: false,
        fullscreen: false,
        lazyLoading: false,
        updateTable: function(instance, cell, x, y, value) {
            // Track changes
            trackChanges(x, y, value);
        }
    });
    
    // Track changes
    let changes = [];
    let isSaving = false;
    const saveBtn = document.getElementById('saveBtn');
    const resetBtn = document.getElementById('resetBtn');
    const saveStatus = document.getElementById('saveStatus');
    const saveMessage = document.getElementById('saveMessage');
    
    function trackChanges(x, y, value) {
        // Remove existing change for this cell
        changes = changes.filter(change => !(change.row === y && change.col === x));
        
        // Get original value
        const originalValue = excelData[y] && excelData[y][x] ? 
            (excelData[y][x].formula || excelData[y][x].value || '') : '';
        
        // Add new change if different from original
        if (value !== originalValue) {
            changes.push({
                row: y,
                col: x,
                value: value
            });
        }
        
        // Enable/disable save button
        saveBtn.disabled = changes.length === 0 || isSaving;
    }
    
    // Save changes
    saveBtn.addEventListener('click', function() {
        if (changes.length === 0 || isSaving) return;
        
        isSaving = true;
        saveBtn.disabled = true;
        saveStatus.style.display = 'block';
        saveMessage.textContent = 'Saving changes...';
        
        fetch(`{% url 'save_excel_changes' filename %}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ changes: changes })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                saveMessage.innerHTML = '<i class="fas fa-check me-2"></i>' + data.message;
                saveStatus.className = 'alert alert-success';
                
                // Clear changes
                changes = [];
                saveBtn.disabled = true;
                
                // Hide status after 3 seconds
                setTimeout(() => {
                    saveStatus.style.display = 'none';
                    saveStatus.className = 'alert alert-info';
                }, 3000);
            } else {
                saveMessage.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error: ' + data.error;
                saveStatus.className = 'alert alert-danger';
            }
        })
        .catch(error => {
            saveMessage.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error: ' + error;
            saveStatus.className = 'alert alert-danger';
        })
        .finally(() => {
            isSaving = false;
            saveBtn.disabled = changes.length === 0;
        });
    });
    
    // Reset changes
    resetBtn.addEventListener('click', function() {
        if (confirm('Are you sure you want to reset all changes? This will restore the original values.')) {
            // Reload the page to reset everything
            window.location.reload();
        }
    });
    
    // Auto-save every 30 seconds if there are changes
    setInterval(function() {
        if (changes.length > 0 && !isSaving) {
            saveBtn.click();
        }
    }, 30000);
});
</script>

<!-- CSRF Token for AJAX requests -->
{% csrf_token %}
{% endblock %}