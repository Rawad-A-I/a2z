{% extends 'base/base.html' %}
{% load static %}

{% block title %}Edit {{ display_name }} - Close Cash{% endblock %}

{% block start %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-file-excel text-warning me-2"></i>
                        {{ display_name }}
                        {% if is_master %}
                            <span class="badge bg-warning text-dark ms-2">Master Analytics</span>
                        {% endif %}
                    </h2>
                    <p class="text-muted mb-0">
                        Last modified: {{ last_modified|date:"M d, Y H:i" }} | 
                        Size: {{ file_size|filesizeformat }}
                    </p>
                </div>
                <div>
                    <a href="{% url 'close_cash_dashboard' %}" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                    </a>
                    <a href="{% url 'download_excel_file' filename %}" class="btn btn-outline-primary">
                        <i class="fas fa-download me-2"></i>Download
                    </a>
                </div>
            </div>

            <!-- Excel Features Info -->
            <div class="alert alert-info mb-4">
                <div class="d-flex align-items-center">
                    <i class="fas fa-info-circle fa-2x me-3 text-info"></i>
                    <div>
                        <h6 class="mb-1"><strong>Excel-like Features Available</strong></h6>
                        <ul class="mb-0">
                            <li><strong>Copy/Paste:</strong> Ctrl+C, Ctrl+V (works with real Excel!)</li>
                            <li><strong>Navigation:</strong> Arrow keys, Tab, Enter, Home, End</li>
                            <li><strong>Selection:</strong> Click and drag, Shift+Click, Ctrl+Click</li>
                            <li><strong>Undo/Redo:</strong> Ctrl+Z, Ctrl+Y</li>
                            <li><strong>Resize:</strong> Drag column/row borders</li>
                            <li><strong>Search:</strong> Ctrl+F to find</li>
                            <li><strong>Auto-save:</strong> Changes saved every 30 seconds</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Save Status -->
            <div id="saveStatus" class="alert alert-info mb-3" style="display: none;">
                <i class="fas fa-spinner fa-spin me-2"></i>
                <span id="saveMessage">Saving changes...</span>
            </div>

            <!-- Excel Spreadsheet Container -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-table me-2"></i>Excel Spreadsheet</h5>
                    <div>
                        <button id="saveBtn" class="btn btn-success" disabled>
                            <i class="fas fa-save me-2"></i>Save Changes
                        </button>
                        <button id="resetBtn" class="btn btn-outline-secondary ms-2">
                            <i class="fas fa-undo me-2"></i>Reset
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="excel-container" style="height: 70vh; width: 100%;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Handsontable CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css">

<!-- Handsontable JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>

<style>
/* Excel-like styling */
#excel-container {
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* Handsontable custom styling for Excel look */
.handsontable {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
    font-size: 13px !important;
}

.handsontable th {
    background-color: #f8f9fa !important;
    border: 1px solid #d1d5db !important;
    font-weight: 600 !important;
    text-align: center !important;
    color: #374151 !important;
}

.handsontable td {
    border: 1px solid #d1d5db !important;
    padding: 4px 8px !important;
    background-color: white !important;
}

.handsontable td.current {
    background-color: #007bff !important;
    color: white !important;
}

.handsontable td.area {
    background-color: #e3f2fd !important;
    border-color: #2196f3 !important;
}

.handsontable td.htDimmed {
    background-color: #f8f9fa !important;
    color: #6c757d !important;
}

/* Save status styling */
#saveStatus {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    min-width: 300px;
}

.btn:disabled {
    opacity: 0.6;
}

/* Excel-like scrollbars */
#excel-container::-webkit-scrollbar {
    width: 12px;
    height: 12px;
}

#excel-container::-webkit-scrollbar-track {
    background: #f1f1f1;
}

#excel-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 6px;
}

#excel-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Excel data from Django
    const excelData = {{ excel_data_json|safe }};
    const maxRow = {{ max_row }};
    const maxCol = {{ max_col }};
    
    // Initialize Handsontable
    const container = document.getElementById('excel-container');
    const hot = new Handsontable(container, {
        data: excelData,
        rowHeaders: true,
        colHeaders: true,
        contextMenu: true,
        manualColumnResize: true,
        manualRowResize: true,
        filters: false,
        dropdownMenu: false,
        copyPaste: true,
        undo: true,
        search: true,
        height: '100%',
        width: '100%',
        stretchH: 'all',
        licenseKey: 'non-commercial-and-evaluation',
        afterChange: function(changes, source) {
            if (source !== 'loadData') {
                trackChanges(changes);
            }
        },
        afterSelection: function(r, c, r2, c2) {
            // Excel-like selection behavior
        },
        beforeKeyDown: function(event) {
            // Excel-like keyboard shortcuts
            if (event.ctrlKey && event.keyCode === 83) { // Ctrl+S
                event.preventDefault();
                saveChanges();
            }
        }
    });
    
    // Track changes
    let changes = [];
    let isSaving = false;
    const saveBtn = document.getElementById('saveBtn');
    const resetBtn = document.getElementById('resetBtn');
    const saveStatus = document.getElementById('saveStatus');
    const saveMessage = document.getElementById('saveMessage');
    
    function trackChanges(changesArray) {
        if (!changesArray) return;
        
        changesArray.forEach(([row, col, oldValue, newValue]) => {
            if (oldValue !== newValue) {
                // Remove existing change for this cell
                changes = changes.filter(change => !(change.row === row + 1 && change.col === col + 1));
                
                // Add new change
                changes.push({
                    row: row + 1,  // Excel uses 1-based indexing
                    col: col + 1,
                    value: newValue
                });
            }
        });
        
        // Enable/disable save button
        saveBtn.disabled = changes.length === 0 || isSaving;
    }
    
    // Save changes
    function saveChanges() {
        if (changes.length === 0 || isSaving) return;
        
        isSaving = true;
        saveBtn.disabled = true;
        saveStatus.style.display = 'block';
        saveMessage.textContent = 'Saving changes...';
        
        fetch(`{% url 'save_excel_changes' filename %}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ changes: changes })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                saveMessage.innerHTML = '<i class="fas fa-check me-2"></i>' + data.message;
                saveStatus.className = 'alert alert-success';
                
                // Clear changes
                changes = [];
                saveBtn.disabled = true;
                
                // Hide status after 3 seconds
                setTimeout(() => {
                    saveStatus.style.display = 'none';
                    saveStatus.className = 'alert alert-info';
                }, 3000);
            } else {
                saveMessage.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error: ' + data.error;
                saveStatus.className = 'alert alert-danger';
            }
        })
        .catch(error => {
            saveMessage.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error: ' + error;
            saveStatus.className = 'alert alert-danger';
        })
        .finally(() => {
            isSaving = false;
            saveBtn.disabled = changes.length === 0;
        });
    }
    
    // Save button click
    saveBtn.addEventListener('click', saveChanges);
    
    // Reset changes
    resetBtn.addEventListener('click', function() {
        if (confirm('Are you sure you want to reset all changes? This will restore the original values.')) {
            // Reload the page to reset everything
            window.location.reload();
        }
    });
    
    // Auto-save every 30 seconds if there are changes
    setInterval(function() {
        if (changes.length > 0 && !isSaving) {
            saveChanges();
        }
    }, 30000);
    
    // Add Excel-like keyboard shortcuts
    document.addEventListener('keydown', function(event) {
        if (event.ctrlKey && event.keyCode === 83) { // Ctrl+S
            event.preventDefault();
            saveChanges();
        }
    });
});
</script>

<!-- CSRF Token for AJAX requests -->
{% csrf_token %}
{% endblock %}