{% extends 'base/base.html' %}
{% load static %}

{% block title %}Employee Close Cash - {{ sheet_name }}{% endblock %}

{% block start %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1"><i class="fas fa-file-alt text-warning me-2"></i>{{ sheet_name }}</h2>
                    <p class="text-muted mb-0">Fill in the required details and submit</p>
                </div>
                <div>
                    <a href="{% url 'employee_forms_dashboard' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>All Dates
                    </a>
                </div>
            </div>

            <div id="statusBox" class="alert" style="display:none;"></div>

            <form method="post" id="closeCashForm">
                {% csrf_token %}
                <input type="hidden" name="entry_date" id="entryDate" value="" />
                
                <div class="accordion" id="formSections">
                    <!-- General Section -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading-general">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#collapse-general" aria-expanded="true" aria-controls="collapse-general">
                                <i class="fas fa-folder me-2"></i>General
                            </button>
                        </h2>
                        <div id="collapse-general" class="accordion-collapse collapse show" 
                             aria-labelledby="heading-general" data-bs-parent="#formSections">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        {{ general_form.black_market_daily_rate.label_tag }}
                                        {{ general_form.black_market_daily_rate }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ general_form.cashier_name.label_tag }}
                                        {{ general_form.cashier_name }}
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        {{ general_form.date.label_tag }}
                                        {{ general_form.date }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ general_form.shift_time.label_tag }}
                                        {{ general_form.shift_time }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lebanese Cash Section -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading-lebanese">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#collapse-lebanese" aria-expanded="false" aria-controls="collapse-lebanese">
                                <i class="fas fa-folder me-2"></i>Lebanese Cash
                            </button>
                        </h2>
                        <div id="collapse-lebanese" class="accordion-collapse collapse" 
                             aria-labelledby="heading-lebanese" data-bs-parent="#formSections">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-2">
                                        {{ lebanese_cash_form.lebanese_5000_qty.label_tag }}
                                        {{ lebanese_cash_form.lebanese_5000_qty }}
                                    </div>
                                    <div class="col-md-2">
                                        {{ lebanese_cash_form.lebanese_10000_qty.label_tag }}
                                        {{ lebanese_cash_form.lebanese_10000_qty }}
                                    </div>
                                    <div class="col-md-2">
                                        {{ lebanese_cash_form.lebanese_20000_qty.label_tag }}
                                        {{ lebanese_cash_form.lebanese_20000_qty }}
                                    </div>
                                    <div class="col-md-2">
                                        {{ lebanese_cash_form.lebanese_50000_qty.label_tag }}
                                        {{ lebanese_cash_form.lebanese_50000_qty }}
                                    </div>
                                    <div class="col-md-2">
                                        {{ lebanese_cash_form.lebanese_100000_qty.label_tag }}
                                        {{ lebanese_cash_form.lebanese_100000_qty }}
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label fw-bold">Total</label>
                                        <input type="number" class="form-control" id="lebanese-total" readonly 
                                               style="background-color: #f8f9fa; border-color: #dee2e6;" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dollar Cash Section -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading-dollar">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#collapse-dollar" aria-expanded="false" aria-controls="collapse-dollar">
                                <i class="fas fa-folder me-2"></i>Dollar Cash
                            </button>
                        </h2>
                        <div id="collapse-dollar" class="accordion-collapse collapse" 
                             aria-labelledby="heading-dollar" data-bs-parent="#formSections">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-2">
                                        {{ dollar_cash_form.dollar_1_qty.label_tag }}
                                        {{ dollar_cash_form.dollar_1_qty }}
                                    </div>
                                    <div class="col-md-2">
                                        {{ dollar_cash_form.dollar_5_qty.label_tag }}
                                        {{ dollar_cash_form.dollar_5_qty }}
                                    </div>
                                    <div class="col-md-2">
                                        {{ dollar_cash_form.dollar_10_qty.label_tag }}
                                        {{ dollar_cash_form.dollar_10_qty }}
                                    </div>
                                    <div class="col-md-2">
                                        {{ dollar_cash_form.dollar_20_qty.label_tag }}
                                        {{ dollar_cash_form.dollar_20_qty }}
                                    </div>
                                    <div class="col-md-2">
                                        {{ dollar_cash_form.dollar_50_qty.label_tag }}
                                        {{ dollar_cash_form.dollar_50_qty }}
                                    </div>
                                    <div class="col-md-2">
                                        {{ dollar_cash_form.dollar_100_qty.label_tag }}
                                        {{ dollar_cash_form.dollar_100_qty }}
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        {{ dollar_cash_form.dollar_rate.label_tag }}
                                        {{ dollar_cash_form.dollar_rate }}
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Total USD</label>
                                        <input type="number" class="form-control" id="dollar-total-usd" readonly 
                                               style="background-color: #f8f9fa; border-color: #dee2e6;" />
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Total LBP</label>
                                        <input type="number" class="form-control" id="dollar-total-lbp" readonly 
                                               style="background-color: #f8f9fa; border-color: #dee2e6;" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Special Credit Section -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading-special">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#collapse-special" aria-expanded="false" aria-controls="collapse-special">
                                <i class="fas fa-folder me-2"></i>Special Credit
                            </button>
                        </h2>
                        <div id="collapse-special" class="accordion-collapse collapse" 
                             aria-labelledby="heading-special" data-bs-parent="#formSections">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        {{ special_credit_form.rayan_invoices_credit.label_tag }}
                                        {{ special_credit_form.rayan_invoices_credit }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ special_credit_form.employee_invoice_credit.label_tag }}
                                        {{ special_credit_form.employee_invoice_credit }}
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        {{ special_credit_form.delivery_shabeb_co.label_tag }}
                                        {{ special_credit_form.delivery_shabeb_co }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ special_credit_form.delivery_employee.label_tag }}
                                        {{ special_credit_form.delivery_employee }}
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        {{ special_credit_form.waste_goods.label_tag }}
                                        {{ special_credit_form.waste_goods }}
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Total</label>
                                        <input type="number" class="form-control" id="special-credit-total" readonly 
                                               style="background-color: #f8f9fa; border-color: #dee2e6;" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Credit Section -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading-credit">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#collapse-credit" aria-expanded="false" aria-controls="collapse-credit">
                                <i class="fas fa-folder me-2"></i>Credit
                            </button>
                        </h2>
                        <div id="collapse-credit" class="accordion-collapse collapse" 
                             aria-labelledby="heading-credit" data-bs-parent="#formSections">
                            <div class="accordion-body">
                                <div class="mb-3">
                                    <button type="button" class="btn btn-sm btn-primary" id="add-credit-entry">
                                        <i class="fas fa-plus me-1"></i>Add Entry
                                    </button>
                                </div>
                                <div id="credit-entries">
                                    {{ credit_formset.management_form }}
                                    {% for form in credit_formset %}
                                        <div class="row mb-2 p-2 border rounded credit-entry">
                                            <div class="col-md-2">
                                                {{ form.amount.label_tag }}
                                                {{ form.amount }}
                                            </div>
                                            <div class="col-md-2">
                                                {{ form.currency.label_tag }}
                                                {{ form.currency }}
                                            </div>
                                            <div class="col-md-3">
                                                {{ form.name.label_tag }}
                                                {{ form.name }}
                                            </div>
                                            <div class="col-md-4">
                                                {{ form.tag.label_tag }}
                                                {{ form.tag }}
                                            </div>
                                            <div class="col-md-1 d-flex align-items-end">
                                                <button type="button" class="btn btn-sm btn-danger remove-credit-entry">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Coffee Machine Section -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading-coffee">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#collapse-coffee" aria-expanded="false" aria-controls="collapse-coffee">
                                <i class="fas fa-folder me-2"></i>Coffee Machine
                            </button>
                        </h2>
                        <div id="collapse-coffee" class="accordion-collapse collapse" 
                             aria-labelledby="heading-coffee" data-bs-parent="#formSections">
                            <div class="accordion-body">
                                <div class="mb-3">
                                    <button type="button" class="btn btn-sm btn-primary" id="add-coffee-entry">
                                        <i class="fas fa-plus me-1"></i>Add Entry
                                    </button>
                                </div>
                                <div id="coffee-entries">
                                    {{ coffee_machine_formset.management_form }}
                                    {% for form in coffee_machine_formset %}
                                        <div class="row mb-2 p-2 border rounded coffee-entry">
                                            <div class="col-md-3">
                                                {{ form.current_amount.label_tag }}
                                                {{ form.current_amount }}
                                            </div>
                                            <div class="col-md-3">
                                                {{ form.daily_add.label_tag }}
                                                {{ form.daily_add }}
                                            </div>
                                            <div class="col-md-5">
                                                {{ form.tag.label_tag }}
                                                {{ form.tag }}
                                            </div>
                                            <div class="col-md-1 d-flex align-items-end">
                                                <button type="button" class="btn btn-sm btn-danger remove-coffee-entry">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-edit me-2"></i>Close Cash Form</h5>
                        <div>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save me-2"></i>{% if sheet_name == 'new' or sheet_name == 'new_submission' %}Submit{% else %}Save Changes{% endif %}
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set today's date as default
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('entryDate').value = today;
    
    // Calculate Lebanese Cash total
    function calculateLebaneseTotal() {
        const qty5000 = parseFloat(document.querySelector('[name="lebanese_5000_qty"]').value) || 0;
        const qty10000 = parseFloat(document.querySelector('[name="lebanese_10000_qty"]').value) || 0;
        const qty20000 = parseFloat(document.querySelector('[name="lebanese_20000_qty"]').value) || 0;
        const qty50000 = parseFloat(document.querySelector('[name="lebanese_50000_qty"]').value) || 0;
        const qty100000 = parseFloat(document.querySelector('[name="lebanese_100000_qty"]').value) || 0;
        
        const total = (qty5000 * 5000) + (qty10000 * 10000) + (qty20000 * 20000) + (qty50000 * 50000) + (qty100000 * 100000);
        document.getElementById('lebanese-total').value = total;
    }
    
    // Calculate Dollar Cash totals
    function calculateDollarTotals() {
        const qty1 = parseFloat(document.querySelector('[name="dollar_1_qty"]').value) || 0;
        const qty5 = parseFloat(document.querySelector('[name="dollar_5_qty"]').value) || 0;
        const qty10 = parseFloat(document.querySelector('[name="dollar_10_qty"]').value) || 0;
        const qty20 = parseFloat(document.querySelector('[name="dollar_20_qty"]').value) || 0;
        const qty50 = parseFloat(document.querySelector('[name="dollar_50_qty"]').value) || 0;
        const qty100 = parseFloat(document.querySelector('[name="dollar_100_qty"]').value) || 0;
        const rate = parseFloat(document.querySelector('[name="dollar_rate"]').value) || 0;
        
        const totalUSD = qty1 + (qty5 * 5) + (qty10 * 10) + (qty20 * 20) + (qty50 * 50) + (qty100 * 100);
        const totalLBP = totalUSD * rate;
        
        document.getElementById('dollar-total-usd').value = totalUSD;
        document.getElementById('dollar-total-lbp').value = totalLBP;
    }
    
    // Calculate Special Credit total
    function calculateSpecialCreditTotal() {
        const rayan = parseFloat(document.querySelector('[name="rayan_invoices_credit"]').value) || 0;
        const employee = parseFloat(document.querySelector('[name="employee_invoice_credit"]').value) || 0;
        const delivery = parseFloat(document.querySelector('[name="delivery_shabeb_co"]').value) || 0;
        const deliveryEmp = parseFloat(document.querySelector('[name="delivery_employee"]').value) || 0;
        const waste = parseFloat(document.querySelector('[name="waste_goods"]').value) || 0;
        
        const total = rayan + employee + delivery + deliveryEmp + waste;
        document.getElementById('special-credit-total').value = total;
    }
    
    // Add event listeners for calculations
    document.querySelectorAll('[name*="lebanese_"]').forEach(input => {
        input.addEventListener('input', calculateLebaneseTotal);
    });
    
    document.querySelectorAll('[name*="dollar_"]').forEach(input => {
        input.addEventListener('input', calculateDollarTotals);
    });
    
    document.querySelectorAll('[name*="credit"]').forEach(input => {
        input.addEventListener('input', calculateSpecialCreditTotal);
    });
    
    // Add Credit Entry
    document.getElementById('add-credit-entry').addEventListener('click', function() {
        const container = document.getElementById('credit-entries');
        const totalForms = document.querySelector('[name="form-TOTAL_FORMS"]');
        const formCount = parseInt(totalForms.value);
        
        const newForm = document.createElement('div');
        newForm.className = 'row mb-2 p-2 border rounded credit-entry';
        newForm.innerHTML = `
            <div class="col-md-2">
                <label class="form-label">Amount</label>
                <input type="number" class="form-control" name="form-${formCount}-amount" step="any" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Currency</label>
                <select class="form-control" name="form-${formCount}-currency">
                    <option value="">Select...</option>
                    <option value="Lebanese">Lebanese</option>
                    <option value="Dollar">Dollar</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Name</label>
                <input type="text" class="form-control" name="form-${formCount}-name" />
            </div>
            <div class="col-md-4">
                <label class="form-label">Tag</label>
                <select class="form-control" name="form-${formCount}-tag">
                    <option value="">Select...</option>
                    <option value="Cash purchase">Cash purchase</option>
                    <option value="Credit invoices">Credit invoices</option>
                    <option value="Employee OTH">Employee OTH</option>
                    <option value="Customer OTH">Customer OTH</option>
                    <option value="Bar OTH">Bar OTH</option>
                    <option value="Store">Store</option>
                </select>
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button type="button" class="btn btn-sm btn-danger remove-credit-entry">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        
        container.appendChild(newForm);
        totalForms.value = formCount + 1;
    });
    
    // Add Coffee Machine Entry
    document.getElementById('add-coffee-entry').addEventListener('click', function() {
        const container = document.getElementById('coffee-entries');
        const totalForms = document.querySelector('[name="form-TOTAL_FORMS"]');
        const formCount = parseInt(totalForms.value);
        
        const newForm = document.createElement('div');
        newForm.className = 'row mb-2 p-2 border rounded coffee-entry';
        newForm.innerHTML = `
            <div class="col-md-3">
                <label class="form-label">Current Amount</label>
                <input type="number" class="form-control" name="form-${formCount}-current_amount" step="any" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Daily Add</label>
                <input type="number" class="form-control" name="form-${formCount}-daily_add" step="any" />
            </div>
            <div class="col-md-5">
                <label class="form-label">Tag</label>
                <select class="form-control" name="form-${formCount}-tag">
                    <option value="">Select...</option>
                    <option value="Paper Cup Small">Paper Cup Small</option>
                    <option value="Paper Cup Big">Paper Cup Big</option>
                    <option value="Plastic Cup Small">Plastic Cup Small</option>
                    <option value="Cover Cup Big">Cover Cup Big</option>
                    <option value="Cover Cup Small">Cover Cup Small</option>
                    <option value="Small Sticks">Small Sticks</option>
                    <option value="Big Sticks">Big Sticks</option>
                    <option value="Nescafe Shalimon">Nescafe Shalimon</option>
                    <option value="Coffee Kg.">Coffee Kg.</option>
                    <option value="Nescafe Kg.">Nescafe Kg.</option>
                    <option value="Coffee Mate Kg.">Coffee Mate Kg.</option>
                    <option value="Cadbury Pouder Kg.">Cadbury Pouder Kg.</option>
                    <option value="Sugar kg.">Sugar kg.</option>
                    <option value="Tea Bags.">Tea Bags.</option>
                    <option value="Nestle kg.">Nestle kg.</option>
                    <option value="Galon 10L.">Galon 10L.</option>
                    <option value="Zanjabil w 3asal">Zanjabil w 3asal</option>
                    <option value="Gaz 12.5 kg.">Gaz 12.5 kg.</option>
                    <option value="Gaz 10 kg.">Gaz 10 kg.</option>
                </select>
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button type="button" class="btn btn-sm btn-danger remove-coffee-entry">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        
        container.appendChild(newForm);
        totalForms.value = formCount + 1;
    });
    
    // Remove entry handlers
    document.addEventListener('click', function(e) {
        if (e.target.closest('.remove-credit-entry')) {
            e.target.closest('.credit-entry').remove();
        }
        if (e.target.closest('.remove-coffee-entry')) {
            e.target.closest('.coffee-entry').remove();
        }
    });
    
    // Form submission
    document.getElementById('closeCashForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = {
            general: {},
            lebanese_cash: {},
            dollar_cash: {},
            special_credit: {},
            credit: [],
            coffee_machine: []
        };
        
        // Collect all form data organized by section
        for (let [key, value] of formData.entries()) {
            // Handle formset data (credit and coffee_machine)
            if (key.startsWith('form-') && key.includes('-')) {
                const parts = key.split('-');
                const formIndex = parseInt(parts[0].replace('form', ''));
                const fieldName = parts.slice(1).join('-');
                
                // Determine if this is credit or coffee_machine based on field names
                if (fieldName === 'amount' || fieldName === 'currency' || fieldName === 'name') {
                    // This is a credit entry
                    if (!data.credit[formIndex]) data.credit[formIndex] = {};
                    data.credit[formIndex][fieldName] = value;
                } else if (fieldName === 'current_amount' || fieldName === 'daily_add') {
                    // This is a coffee_machine entry
                    if (!data.coffee_machine[formIndex]) data.coffee_machine[formIndex] = {};
                    data.coffee_machine[formIndex][fieldName] = value;
                } else if (fieldName === 'tag') {
                    // Tag field could be for either credit or coffee_machine
                    // We need to check which formset this belongs to by checking other fields
                    // For now, we'll check if the index already exists in credit or coffee_machine
                    if (data.credit[formIndex] && Object.keys(data.credit[formIndex]).length > 0) {
                        data.credit[formIndex][fieldName] = value;
                    } else if (data.coffee_machine[formIndex] && Object.keys(data.coffee_machine[formIndex]).length > 0) {
                        data.coffee_machine[formIndex][fieldName] = value;
                    } else {
                        // Default to coffee_machine if not sure
                        if (!data.coffee_machine[formIndex]) data.coffee_machine[formIndex] = {};
                        data.coffee_machine[formIndex][fieldName] = value;
                    }
                }
            }
            // Handle general section fields
            else if (key === 'black_market_daily_rate' || key === 'cashier_name' || key === 'date' || key === 'shift_time') {
                data.general[key] = value;
            }
            // Handle lebanese cash fields
            else if (key.startsWith('lebanese_')) {
                data.lebanese_cash[key] = value;
            }
            // Handle dollar cash fields
            else if (key.startsWith('dollar_')) {
                data.dollar_cash[key] = value;
            }
            // Handle special credit fields
            else if (key === 'rayan_invoices_credit' || key === 'employee_invoice_credit' || 
                     key === 'delivery_shabeb_co' || key === 'delivery_employee' || key === 'waste_goods') {
                data.special_credit[key] = value;
            }
        }
        
        // Calculate and add totals
        // Lebanese Cash Total
        const lbpQty5000 = parseFloat(data.lebanese_cash.lebanese_5000_qty) || 0;
        const lbpQty10000 = parseFloat(data.lebanese_cash.lebanese_10000_qty) || 0;
        const lbpQty20000 = parseFloat(data.lebanese_cash.lebanese_20000_qty) || 0;
        const lbpQty50000 = parseFloat(data.lebanese_cash.lebanese_50000_qty) || 0;
        const lbpQty100000 = parseFloat(data.lebanese_cash.lebanese_100000_qty) || 0;
        data.lebanese_cash_total = (lbpQty5000 * 5000) + (lbpQty10000 * 10000) + (lbpQty20000 * 20000) + 
                                    (lbpQty50000 * 50000) + (lbpQty100000 * 100000);
        
        // Dollar Cash Totals
        const usdQty1 = parseFloat(data.dollar_cash.dollar_1_qty) || 0;
        const usdQty5 = parseFloat(data.dollar_cash.dollar_5_qty) || 0;
        const usdQty10 = parseFloat(data.dollar_cash.dollar_10_qty) || 0;
        const usdQty20 = parseFloat(data.dollar_cash.dollar_20_qty) || 0;
        const usdQty50 = parseFloat(data.dollar_cash.dollar_50_qty) || 0;
        const usdQty100 = parseFloat(data.dollar_cash.dollar_100_qty) || 0;
        const dollarRate = parseFloat(data.dollar_cash.dollar_rate) || 0;
        data.dollar_cash_total_usd = usdQty1 + (usdQty5 * 5) + (usdQty10 * 10) + (usdQty20 * 20) + 
                                      (usdQty50 * 50) + (usdQty100 * 100);
        data.dollar_cash_total_lbp = data.dollar_cash_total_usd * dollarRate;
        
        // Special Credit Total
        const rayanCredit = parseFloat(data.special_credit.rayan_invoices_credit) || 0;
        const employeeCredit = parseFloat(data.special_credit.employee_invoice_credit) || 0;
        const deliveryShabeb = parseFloat(data.special_credit.delivery_shabeb_co) || 0;
        const deliveryEmployee = parseFloat(data.special_credit.delivery_employee) || 0;
        const wasteGoods = parseFloat(data.special_credit.waste_goods) || 0;
        data.special_credit_total = rayanCredit + employeeCredit + deliveryShabeb + deliveryEmployee + wasteGoods;
        
        // Credit totals by tag
        let cashPurchaseTotal = 0, creditInvoicesTotal = 0, employeeOthTotal = 0;
        let customerOthTotal = 0, barOthTotal = 0, storeTotal = 0;
        
        data.credit.forEach(entry => {
            const amount = parseFloat(entry.amount) || 0;
            const tag = entry.tag;
            if (tag === 'Cash purchase') cashPurchaseTotal += amount;
            else if (tag === 'Credit invoices') creditInvoicesTotal += amount;
            else if (tag === 'Employee OTH') employeeOthTotal += amount;
            else if (tag === 'Customer OTH') customerOthTotal += amount;
            else if (tag === 'Bar OTH') barOthTotal += amount;
            else if (tag === 'Store') storeTotal += amount;
        });
        
        data.cash_purchase_total = cashPurchaseTotal;
        data.credit_invoices_total = creditInvoicesTotal;
        data.employee_oth_total = employeeOthTotal;
        data.customer_oth_total = customerOthTotal;
        data.bar_oth_total = barOthTotal;
        data.store_total = storeTotal;
        data.credit_grand_total = cashPurchaseTotal + creditInvoicesTotal + employeeOthTotal + 
                                   customerOthTotal + barOthTotal + storeTotal;
        
        // Summary Results
        data.cash_in_hand_dollar = data.dollar_cash_total_lbp;
        data.cash_in_hand_lebanese = data.lebanese_cash_total;
        data.cash_out_of_hand = data.special_credit_total + data.credit_grand_total;
        data.grand_total = data.cash_in_hand_dollar + data.cash_in_hand_lebanese + data.cash_out_of_hand;
        
        // Log the data structure before sending
        console.log('Submitting data:', JSON.stringify(data, null, 2));
        console.log('Entry date:', document.getElementById('entryDate').value);
        console.log('Sheet name from URL:', window.location.pathname);
        
        // Submit via AJAX
        fetch(window.location.pathname + 'submit/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                data: data,
                entry_date: document.getElementById('entryDate').value
            })
        })
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            if (data.success) {
                document.getElementById('statusBox').className = 'alert alert-success';
                document.getElementById('statusBox').innerHTML = '<i class="fas fa-check me-2"></i>Saved successfully';
                document.getElementById('statusBox').style.display = 'block';
                
                if (data.redirect_url) {
                    setTimeout(() => {
                        window.location.href = data.redirect_url;
                    }, 1000);
                } else {
                    // For edit mode, scroll to top to see success message
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            } else {
                document.getElementById('statusBox').className = 'alert alert-danger';
                document.getElementById('statusBox').innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>' + (data.error || 'Error saving');
                document.getElementById('statusBox').style.display = 'block';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            document.getElementById('statusBox').className = 'alert alert-danger';
            document.getElementById('statusBox').innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error: ' + error;
            document.getElementById('statusBox').style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    });
});
</script>
{% endblock %}