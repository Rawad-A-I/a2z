{% extends 'base/base.html' %}
{% load static %}

{% block title %}Employee Close Cash - {{ sheet_name }}{% endblock %}

{% block start %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1"><i class="fas fa-file-alt text-warning me-2"></i>{{ sheet_name }}</h2>
                    <p class="text-muted mb-0">Fill in the required details and submit</p>
                </div>
                <div>
                    <a href="{% url 'employee_forms_dashboard' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>All Dates
                    </a>
                </div>
            </div>

            <div id="statusBox" class="alert" style="display:none;"></div>

            <form method="post" id="closeCashForm">
                {% csrf_token %}
                <input type="hidden" name="entry_date" id="entryDate" value="" />
                
                <div class="accordion" id="formSections">
                    <!-- General Section -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading-general">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#collapse-general" aria-expanded="true" aria-controls="collapse-general">
                                <i class="fas fa-folder me-2"></i>General
                            </button>
                        </h2>
                        <div id="collapse-general" class="accordion-collapse collapse show" 
                             aria-labelledby="heading-general" data-bs-parent="#formSections">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        {{ general_form.black_market_daily_rate.label_tag }}
                                        {{ general_form.black_market_daily_rate }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ general_form.cashier_name.label_tag }}
                                        {{ general_form.cashier_name }}
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        {{ general_form.date.label_tag }}
                                        {{ general_form.date }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ general_form.shift_time.label_tag }}
                                        {{ general_form.shift_time }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lebanese Cash Section -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading-lebanese">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#collapse-lebanese" aria-expanded="false" aria-controls="collapse-lebanese">
                                <i class="fas fa-folder me-2"></i>Lebanese Cash
                            </button>
                        </h2>
                        <div id="collapse-lebanese" class="accordion-collapse collapse" 
                             aria-labelledby="heading-lebanese" data-bs-parent="#formSections">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-2">
                                        {{ lebanese_cash_form.lebanese_5000_qty.label_tag }}
                                        {{ lebanese_cash_form.lebanese_5000_qty }}
                                    </div>
                                    <div class="col-md-2">
                                        {{ lebanese_cash_form.lebanese_10000_qty.label_tag }}
                                        {{ lebanese_cash_form.lebanese_10000_qty }}
                                    </div>
                                    <div class="col-md-2">
                                        {{ lebanese_cash_form.lebanese_20000_qty.label_tag }}
                                        {{ lebanese_cash_form.lebanese_20000_qty }}
                                    </div>
                                    <div class="col-md-2">
                                        {{ lebanese_cash_form.lebanese_50000_qty.label_tag }}
                                        {{ lebanese_cash_form.lebanese_50000_qty }}
                                    </div>
                                    <div class="col-md-2">
                                        {{ lebanese_cash_form.lebanese_100000_qty.label_tag }}
                                        {{ lebanese_cash_form.lebanese_100000_qty }}
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label fw-bold">Total</label>
                                        <input type="number" class="form-control" id="lebanese-total" readonly 
                                               style="background-color: #f8f9fa; border-color: #dee2e6;" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dollar Cash Section -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading-dollar">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#collapse-dollar" aria-expanded="false" aria-controls="collapse-dollar">
                                <i class="fas fa-folder me-2"></i>Dollar Cash
                            </button>
                        </h2>
                        <div id="collapse-dollar" class="accordion-collapse collapse" 
                             aria-labelledby="heading-dollar" data-bs-parent="#formSections">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-2">
                                        {{ dollar_cash_form.dollar_1_qty.label_tag }}
                                        {{ dollar_cash_form.dollar_1_qty }}
                                    </div>
                                    <div class="col-md-2">
                                        {{ dollar_cash_form.dollar_5_qty.label_tag }}
                                        {{ dollar_cash_form.dollar_5_qty }}
                                    </div>
                                    <div class="col-md-2">
                                        {{ dollar_cash_form.dollar_10_qty.label_tag }}
                                        {{ dollar_cash_form.dollar_10_qty }}
                                    </div>
                                    <div class="col-md-2">
                                        {{ dollar_cash_form.dollar_20_qty.label_tag }}
                                        {{ dollar_cash_form.dollar_20_qty }}
                                    </div>
                                    <div class="col-md-2">
                                        {{ dollar_cash_form.dollar_50_qty.label_tag }}
                                        {{ dollar_cash_form.dollar_50_qty }}
                                    </div>
                                    <div class="col-md-2">
                                        {{ dollar_cash_form.dollar_100_qty.label_tag }}
                                        {{ dollar_cash_form.dollar_100_qty }}
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        {{ dollar_cash_form.dollar_rate.label_tag }}
                                        {{ dollar_cash_form.dollar_rate }}
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Total USD</label>
                                        <input type="number" class="form-control" id="dollar-total-usd" readonly 
                                               style="background-color: #f8f9fa; border-color: #dee2e6;" />
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold">Total LBP</label>
                                        <input type="number" class="form-control" id="dollar-total-lbp" readonly 
                                               style="background-color: #f8f9fa; border-color: #dee2e6;" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Special Credit Section -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading-special">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#collapse-special" aria-expanded="false" aria-controls="collapse-special">
                                <i class="fas fa-folder me-2"></i>Special Credit
                            </button>
                        </h2>
                        <div id="collapse-special" class="accordion-collapse collapse" 
                             aria-labelledby="heading-special" data-bs-parent="#formSections">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        {{ special_credit_form.rayan_invoices_credit.label_tag }}
                                        {{ special_credit_form.rayan_invoices_credit }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ special_credit_form.employee_invoice_credit.label_tag }}
                                        {{ special_credit_form.employee_invoice_credit }}
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        {{ special_credit_form.delivery_shabeb_co.label_tag }}
                                        {{ special_credit_form.delivery_shabeb_co }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ special_credit_form.delivery_employee.label_tag }}
                                        {{ special_credit_form.delivery_employee }}
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        {{ special_credit_form.waste_goods.label_tag }}
                                        {{ special_credit_form.waste_goods }}
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Total</label>
                                        <input type="number" class="form-control" id="special-credit-total" readonly 
                                               style="background-color: #f8f9fa; border-color: #dee2e6;" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Credit Section -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading-credit">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#collapse-credit" aria-expanded="false" aria-controls="collapse-credit">
                                <i class="fas fa-folder me-2"></i>Credit
                            </button>
                        </h2>
                        <div id="collapse-credit" class="accordion-collapse collapse" 
                             aria-labelledby="heading-credit" data-bs-parent="#formSections">
                            <div class="accordion-body">
                                <div class="mb-3">
                                    <button type="button" class="btn btn-sm btn-primary" id="add-credit-entry">
                                        <i class="fas fa-plus me-1"></i>Add Entry
                                    </button>
                                </div>
                                <div id="credit-entries">
                                    {{ credit_formset.management_form }}
                                    {% for form in credit_formset %}
                                        <div class="row mb-2 p-2 border rounded credit-entry">
                                            <div class="col-md-2">
                                                {{ form.amount.label_tag }}
                                                {{ form.amount }}
                                            </div>
                                            <div class="col-md-2">
                                                {{ form.currency.label_tag }}
                                                {{ form.currency }}
                                            </div>
                                            <div class="col-md-3">
                                                {{ form.name.label_tag }}
                                                {{ form.name }}
                                            </div>
                                            <div class="col-md-4">
                                                {{ form.tag.label_tag }}
                                                {{ form.tag }}
                                            </div>
                                            <div class="col-md-1 d-flex align-items-end">
                                                <button type="button" class="btn btn-sm btn-danger remove-credit-entry">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Coffee Machine Section -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading-coffee">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#collapse-coffee" aria-expanded="false" aria-controls="collapse-coffee">
                                <i class="fas fa-folder me-2"></i>Coffee Machine
                            </button>
                        </h2>
                        <div id="collapse-coffee" class="accordion-collapse collapse" 
                             aria-labelledby="heading-coffee" data-bs-parent="#formSections">
                            <div class="accordion-body">
                                <div class="mb-3">
                                    <button type="button" class="btn btn-sm btn-primary" id="add-coffee-entry">
                                        <i class="fas fa-plus me-1"></i>Add Entry
                                    </button>
                                </div>
                                <div id="coffee-entries">
                                    {{ coffee_machine_formset.management_form }}
                                    {% for form in coffee_machine_formset %}
                                        <div class="row mb-2 p-2 border rounded coffee-entry">
                                            <div class="col-md-3">
                                                {{ form.current_amount.label_tag }}
                                                {{ form.current_amount }}
                                            </div>
                                            <div class="col-md-3">
                                                {{ form.daily_add.label_tag }}
                                                {{ form.daily_add }}
                                            </div>
                                            <div class="col-md-5">
                                                {{ form.tag.label_tag }}
                                                {{ form.tag }}
                                            </div>
                                            <div class="col-md-1 d-flex align-items-end">
                                                <button type="button" class="btn btn-sm btn-danger remove-coffee-entry">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-edit me-2"></i>Close Cash Form</h5>
                        <div>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save me-2"></i>{% if sheet_name == 'new' or sheet_name == 'new_submission' %}Submit{% else %}Save Changes{% endif %}
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set today's date as default
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('entryDate').value = today;
    
    // Calculate Lebanese Cash total
    function calculateLebaneseTotal() {
        const qty5000 = parseFloat(document.querySelector('[name="lebanese_5000_qty"]').value) || 0;
        const qty10000 = parseFloat(document.querySelector('[name="lebanese_10000_qty"]').value) || 0;
        const qty20000 = parseFloat(document.querySelector('[name="lebanese_20000_qty"]').value) || 0;
        const qty50000 = parseFloat(document.querySelector('[name="lebanese_50000_qty"]').value) || 0;
        const qty100000 = parseFloat(document.querySelector('[name="lebanese_100000_qty"]').value) || 0;
        
        const total = (qty5000 * 5000) + (qty10000 * 10000) + (qty20000 * 20000) + (qty50000 * 50000) + (qty100000 * 100000);
        document.getElementById('lebanese-total').value = total;
    }
    
    // Calculate Dollar Cash totals
    function calculateDollarTotals() {
        const qty1 = parseFloat(document.querySelector('[name="dollar_1_qty"]').value) || 0;
        const qty5 = parseFloat(document.querySelector('[name="dollar_5_qty"]').value) || 0;
        const qty10 = parseFloat(document.querySelector('[name="dollar_10_qty"]').value) || 0;
        const qty20 = parseFloat(document.querySelector('[name="dollar_20_qty"]').value) || 0;
        const qty50 = parseFloat(document.querySelector('[name="dollar_50_qty"]').value) || 0;
        const qty100 = parseFloat(document.querySelector('[name="dollar_100_qty"]').value) || 0;
        const rate = parseFloat(document.querySelector('[name="dollar_rate"]').value) || 0;
        
        const totalUSD = qty1 + (qty5 * 5) + (qty10 * 10) + (qty20 * 20) + (qty50 * 50) + (qty100 * 100);
        const totalLBP = totalUSD * rate;
        
        document.getElementById('dollar-total-usd').value = totalUSD;
        document.getElementById('dollar-total-lbp').value = totalLBP;
    }
    
    // Calculate Special Credit total
    function calculateSpecialCreditTotal() {
        const rayan = parseFloat(document.querySelector('[name="rayan_invoices_credit"]').value) || 0;
        const employee = parseFloat(document.querySelector('[name="employee_invoice_credit"]').value) || 0;
        const delivery = parseFloat(document.querySelector('[name="delivery_shabeb_co"]').value) || 0;
        const deliveryEmp = parseFloat(document.querySelector('[name="delivery_employee"]').value) || 0;
        const waste = parseFloat(document.querySelector('[name="waste_goods"]').value) || 0;
        
        const total = rayan + employee + delivery + deliveryEmp + waste;
        document.getElementById('special-credit-total').value = total;
    }
    
    // Add event listeners for calculations
    document.querySelectorAll('[name*="lebanese_"]').forEach(input => {
        input.addEventListener('input', calculateLebaneseTotal);
    });
    
    document.querySelectorAll('[name*="dollar_"]').forEach(input => {
        input.addEventListener('input', calculateDollarTotals);
    });
    
    document.querySelectorAll('[name*="credit"]').forEach(input => {
        input.addEventListener('input', calculateSpecialCreditTotal);
    });
    
    // Add Credit Entry
    document.getElementById('add-credit-entry').addEventListener('click', function() {
        const container = document.getElementById('credit-entries');
        const totalForms = document.querySelector('[name="form-TOTAL_FORMS"]');
        const formCount = parseInt(totalForms.value);
        
        const newForm = document.createElement('div');
        newForm.className = 'row mb-2 p-2 border rounded credit-entry';
        newForm.innerHTML = `
            <div class="col-md-2">
                <label class="form-label">Amount</label>
                <input type="number" class="form-control" name="form-${formCount}-amount" step="any" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Currency</label>
                <select class="form-control" name="form-${formCount}-currency">
                    <option value="">Select...</option>
                    <option value="Lebanese">Lebanese</option>
                    <option value="Dollar">Dollar</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Name</label>
                <input type="text" class="form-control" name="form-${formCount}-name" />
            </div>
            <div class="col-md-4">
                <label class="form-label">Tag</label>
                <select class="form-control" name="form-${formCount}-tag">
                    <option value="">Select...</option>
                    <option value="Cash purchase">Cash purchase</option>
                    <option value="Credit invoices">Credit invoices</option>
                    <option value="Employee OTH">Employee OTH</option>
                    <option value="Customer OTH">Customer OTH</option>
                    <option value="Bar OTH">Bar OTH</option>
                    <option value="Store">Store</option>
                </select>
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button type="button" class="btn btn-sm btn-danger remove-credit-entry">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        
        container.appendChild(newForm);
        totalForms.value = formCount + 1;
    });
    
    // Add Coffee Machine Entry
    document.getElementById('add-coffee-entry').addEventListener('click', function() {
        const container = document.getElementById('coffee-entries');
        const totalForms = document.querySelector('[name="form-TOTAL_FORMS"]');
        const formCount = parseInt(totalForms.value);
        
        const newForm = document.createElement('div');
        newForm.className = 'row mb-2 p-2 border rounded coffee-entry';
        newForm.innerHTML = `
            <div class="col-md-3">
                <label class="form-label">Current Amount</label>
                <input type="number" class="form-control" name="form-${formCount}-current_amount" step="any" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Daily Add</label>
                <input type="number" class="form-control" name="form-${formCount}-daily_add" step="any" />
            </div>
            <div class="col-md-5">
                <label class="form-label">Tag</label>
                <select class="form-control" name="form-${formCount}-tag">
                    <option value="">Select...</option>
                    <option value="Paper Cup Small">Paper Cup Small</option>
                    <option value="Paper Cup Big">Paper Cup Big</option>
                    <option value="Plastic Cup Small">Plastic Cup Small</option>
                    <option value="Cover Cup Big">Cover Cup Big</option>
                    <option value="Cover Cup Small">Cover Cup Small</option>
                    <option value="Small Sticks">Small Sticks</option>
                    <option value="Big Sticks">Big Sticks</option>
                    <option value="Nescafe Shalimon">Nescafe Shalimon</option>
                    <option value="Coffee Kg.">Coffee Kg.</option>
                    <option value="Nescafe Kg.">Nescafe Kg.</option>
                    <option value="Coffee Mate Kg.">Coffee Mate Kg.</option>
                    <option value="Cadbury Pouder Kg.">Cadbury Pouder Kg.</option>
                    <option value="Sugar kg.">Sugar kg.</option>
                    <option value="Tea Bags.">Tea Bags.</option>
                    <option value="Nestle kg.">Nestle kg.</option>
                    <option value="Galon 10L.">Galon 10L.</option>
                    <option value="Zanjabil w 3asal">Zanjabil w 3asal</option>
                    <option value="Gaz 12.5 kg.">Gaz 12.5 kg.</option>
                    <option value="Gaz 10 kg.">Gaz 10 kg.</option>
                </select>
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button type="button" class="btn btn-sm btn-danger remove-coffee-entry">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        
        container.appendChild(newForm);
        totalForms.value = formCount + 1;
    });
    
    // Remove entry handlers
    document.addEventListener('click', function(e) {
        if (e.target.closest('.remove-credit-entry')) {
            e.target.closest('.credit-entry').remove();
        }
        if (e.target.closest('.remove-coffee-entry')) {
            e.target.closest('.coffee-entry').remove();
        }
    });
    
    // Form submission
    document.getElementById('closeCashForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = {};
        
        // Collect all form data
        for (let [key, value] of formData.entries()) {
            if (key.startsWith('form-') && key.includes('-')) {
                const [formType, fieldName] = key.split('-', 2);
                if (!data[formType]) data[formType] = [];
                const index = parseInt(formType.replace('form', ''));
                if (!data[formType][index]) data[formType][index] = {};
                data[formType][index][fieldName] = value;
            } else {
                data[key] = value;
            }
        }
        
        // Submit via AJAX
        fetch(window.location.pathname + 'submit/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                data: data,
                entry_date: document.getElementById('entryDate').value
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('statusBox').className = 'alert alert-success';
                document.getElementById('statusBox').innerHTML = '<i class="fas fa-check me-2"></i>Saved successfully';
                document.getElementById('statusBox').style.display = 'block';
                
                if (data.redirect_url) {
                    setTimeout(() => {
                        window.location.href = data.redirect_url;
                    }, 1000);
                }
            } else {
                document.getElementById('statusBox').className = 'alert alert-danger';
                document.getElementById('statusBox').innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>' + (data.error || 'Error saving');
                document.getElementById('statusBox').style.display = 'block';
            }
        })
        .catch(error => {
            document.getElementById('statusBox').className = 'alert alert-danger';
            document.getElementById('statusBox').innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error: ' + error;
            document.getElementById('statusBox').style.display = 'block';
        });
    });
});
</script>
{% endblock %}