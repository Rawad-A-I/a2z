{% extends 'base/base.html' %}
{% load static %}

{% block title %}Product Management - Employee Dashboard{% endblock %}

{% block start %}
<style>
/* Enhanced colorful styling for product management */
.stats-card {
    border-radius: 20px !important;
    overflow: hidden !important;
    transition: all 0.3s ease !important;
    border: none !important;
}

.stats-card:hover {
    transform: translateY(-5px) !important;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2) !important;
}

.stats-card.bg-primary {
    background-color: #007bff !important;
    color: #ffffff !important;
    box-shadow: 0 4px 15px rgba(0, 123, 255, 0.2) !important;
}

.stats-card.bg-warning {
    background-color: #ffc107 !important;
    color: #ffffff !important;
    box-shadow: 0 4px 15px rgba(255, 193, 7, 0.2) !important;
}

.stats-card.bg-danger {
    background-color: #dc3545 !important;
    color: #ffffff !important;
    box-shadow: 0 4px 15px rgba(220, 53, 69, 0.2) !important;
}

.stats-card.bg-success {
    background-color: #28a745 !important;
    color: #ffffff !important;
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2) !important;
}

.stats-icon {
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2)) !important;
}

.stats-number {
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
    font-weight: 700 !important;
}

.stats-label {
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
    opacity: 0.9 !important;
}

/* Enhanced card styling */
.card {
    border-radius: 15px !important;
    overflow: hidden !important;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1) !important;
    transition: all 0.3s ease !important;
}

.card:hover {
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15) !important;
}

/* Enhanced button styling */
.btn {
    border-radius: 10px !important;
    transition: all 0.3s ease !important;
}

.btn:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2) !important;
}
</style>
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
                <h2 class="mb-3 mb-md-0"><i class="fas fa-boxes"></i> Product Management</h2>
                <div class="btn-group w-100 w-md-auto">
                    <a href="{% url 'add_product' %}" class="btn btn-success">
                        <i class="fas fa-plus"></i> <span class="d-none d-sm-inline">Add Product</span>
                    </a>
                    <a href="{% url 'product_analytics' %}" class="btn btn-info">
                        <i class="fas fa-chart-line"></i> <span class="d-none d-sm-inline">Analytics</span>
                    </a>
                    <a href="{% url 'bulk_barcode_upload' %}" class="btn btn-warning">
                        <i class="fas fa-upload"></i> <span class="d-none d-sm-inline">Bulk Upload</span>
                    </a>
                    <a href="{% url 'employee_hub' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> <span class="d-none d-sm-inline">Back to Hub</span>
                    </a>
                </div>
            </div>

            <!-- Back Button -->
            {% include 'base/back_button.html' with back_text='Back to Hub' %}
            
            <!-- Quick Stats -->
            <div class="row mb-4">
                <div class="col-6 col-md-3 mb-3">
                    <div class="card bg-primary text-white h-100 stats-card">
                        <div class="card-body text-center">
                            <i class="fas fa-boxes fa-2x mb-2 stats-icon"></i>
                            <h4 class="mb-1 stats-number">{{ total_products|default:"0" }}</h4>
                            <p class="mb-0 small stats-label">Total Products</p>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-3 mb-3">
                    <div class="card bg-warning text-white h-100 stats-card">
                        <div class="card-body text-center">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2 stats-icon"></i>
                            <h4 class="mb-1 stats-number">{{ low_stock_count|default:"0" }}</h4>
                            <p class="mb-0 small stats-label">Low Stock</p>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-3 mb-3">
                    <div class="card bg-danger text-white h-100 stats-card">
                        <div class="card-body text-center">
                            <i class="fas fa-times-circle fa-2x mb-2 stats-icon"></i>
                            <h4 class="mb-1 stats-number">{{ out_of_stock_count|default:"0" }}</h4>
                            <p class="mb-0 small stats-label">Out of Stock</p>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-3 mb-3">
                    <div class="card bg-success text-white h-100 stats-card">
                        <div class="card-body text-center">
                            <i class="fas fa-star fa-2x mb-2 stats-icon"></i>
                            <h4 class="mb-1 stats-number">{{ newest_products_count|default:"0" }}</h4>
                            <p class="mb-0 small stats-label">New Products</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Advanced Filters -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-filter"></i> Advanced Filters & Search</h5>
                </div>
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-3">
                            <label for="search" class="form-label">Search Products</label>
                            <input type="text" class="form-control" id="search" name="search" 
                                   value="{{ request.GET.search }}" placeholder="Search by name, description, or category">
                        </div>
                        <div class="col-md-2">
                            <label for="category" class="form-label">Category</label>
                            <select class="form-select" id="category" name="category">
                                <option value="">All Categories</option>
                                {% for category in categories %}
                                    <option value="{{ category.uid }}" 
                                            {% if request.GET.category == category.uid|stringformat:"s" %}selected{% endif %}>
                                        {{ category.category_name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="stock" class="form-label">Stock Status</label>
                            <select class="form-select" id="stock" name="stock">
                                <option value="">All Stock</option>
                                <option value="low" {% if request.GET.stock == 'low' %}selected{% endif %}>Low Stock</option>
                                <option value="out" {% if request.GET.stock == 'out' %}selected{% endif %}>Out of Stock</option>
                                <option value="in" {% if request.GET.stock == 'in' %}selected{% endif %}>In Stock</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="sort" class="form-label">Sort By</label>
                            <select class="form-select" id="sort" name="sort">
                                <option value="-created_at" {% if request.GET.sort == '-created_at' %}selected{% endif %}>Newest First</option>
                                <option value="created_at" {% if request.GET.sort == 'created_at' %}selected{% endif %}>Oldest First</option>
                                <option value="product_name" {% if request.GET.sort == 'product_name' %}selected{% endif %}>Name A-Z</option>
                                <option value="-product_name" {% if request.GET.sort == '-product_name' %}selected{% endif %}>Name Z-A</option>
                                <option value="price" {% if request.GET.sort == 'price' %}selected{% endif %}>Price Low-High</option>
                                <option value="-price" {% if request.GET.sort == '-price' %}selected{% endif %}>Price High-Low</option>
                                <option value="stock_quantity" {% if request.GET.sort == 'stock_quantity' %}selected{% endif %}>Stock Low-High</option>
                                <option value="-stock_quantity" {% if request.GET.sort == '-stock_quantity' %}selected{% endif %}>Stock High-Low</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i> Filter
                                </button>
                                <a href="{% url 'employee_product_management' %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-times"></i> Clear
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Products Table -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list"></i> Products 
                        <span class="badge bg-primary">{{ products.paginator.count }}</span>
                    </h5>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="exportProducts()">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <button class="btn btn-outline-success" onclick="showBulkActions()">
                            <i class="fas fa-edit"></i> Bulk Actions
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th>
                                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                    </th>
                                    <th>Product</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Barcodes</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for product in products %}
                                <tr>
                                    <td>
                                        <input type="checkbox" class="product-checkbox" value="{{ product.uid }}">
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="bg-light rounded me-3 d-flex align-items-center justify-content-center"
                                                 style="width: 50px; height: 50px;">
                                                <i class="fas fa-box text-muted"></i>
                                            </div>
                                            <div>
                                                <strong>{{ product.product_name }}</strong>
                                                <br>
                                                <small class="text-muted">{{ product.product_desription|truncatechars:50 }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ product.category.category_name }}</span>
                                    </td>
                                    <td>
                                        <strong>${{ product.price }}</strong>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <span class="me-2">{{ product.stock_quantity }}</span>
                                            {% if product.stock_quantity <= 0 %}
                                                <span class="badge bg-danger">Out of Stock</span>
                                            {% elif product.stock_quantity <= product.low_stock_threshold %}
                                                <span class="badge bg-warning">Low Stock</span>
                                            {% else %}
                                                <span class="badge bg-success">In Stock</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        {% with barcodes=product.barcodes.all %}
                                            {% if barcodes %}
                                                <span class="badge bg-info">{{ barcodes.count }} barcode{{ barcodes.count|pluralize }}</span>
                                                <br>
                                                <small class="text-muted">
                                                    {% for barcode in barcodes %}
                                                        {% if barcode.is_primary %}
                                                            Primary: {{ barcode.barcode_value }}
                                                        {% endif %}
                                                    {% endfor %}
                                                </small>
                                            {% else %}
                                                <span class="badge bg-warning">No barcodes</span>
                                            {% endif %}
                                        {% endwith %}
                                    </td>
                                    <td>
                                        <span class="badge 
                                            {% if product.is_in_stock %}bg-success{% else %}bg-danger{% endif %}">
                                            {% if product.is_in_stock %}
                                                Active
                                            {% else %}
                                                Out of stock
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{% url 'get_product' product.slug %}" 
                                               class="btn btn-outline-primary" title="View Product">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{% url 'quick_edit_product' product.uid %}" 
                                               class="btn btn-outline-warning" title="Quick Edit">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a href="{% url 'product_barcode_management' product.uid %}" 
                                               class="btn btn-outline-info" title="Manage Barcodes">
                                                <i class="fas fa-barcode"></i>
                                            </a>
                                            <a href="{% url 'barcode_search' %}?product={{ product.uid }}" 
                                               class="btn btn-outline-secondary" title="Search Barcodes">
                                                <i class="fas fa-search"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center py-4">
                                        <i class="fas fa-box fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">No products found</p>
                                        <a href="{% url 'add_product' %}" class="btn btn-success">
                                            <i class="fas fa-plus"></i> Add First Product
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer">
                    <nav aria-label="Products pagination">
                        <ul class="pagination justify-content-center mb-0">
                            {% if products.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">First</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ products.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Previous</a>
                                </li>
                            {% endif %}

                            <li class="page-item active">
                                <span class="page-link">
                                    Page {{ products.number }} of {{ products.paginator.num_pages }}
                                </span>
                            </li>

                            {% if products.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ products.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Next</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ products.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Last</a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Actions Modal -->
<div class="modal fade" id="bulkActionsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Actions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{% url 'bulk_product_actions' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Action</label>
                        <select class="form-select" name="action" id="bulkAction" onchange="toggleBulkFields()">
                            <option value="">Select Action</option>
                            <option value="update_stock">Update Stock</option>
                            <option value="update_price">Update Price</option>
                            <option value="toggle_newest">Toggle Newest Status</option>
                            <option value="delete">Delete Products</option>
                        </select>
                    </div>
                    
                    <div id="stockField" class="mb-3" style="display: none;">
                        <label class="form-label">New Stock Quantity</label>
                        <input type="number" class="form-control" name="stock_value" min="0">
                    </div>
                    
                    <div id="priceField" class="mb-3" style="display: none;">
                        <label class="form-label">New Price</label>
                        <input type="number" class="form-control" name="price_value" min="0" step="0.01">
                    </div>
                    
                    <div class="alert alert-warning" id="deleteWarning" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Warning:</strong> This action cannot be undone!
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="executeBulkAction">Execute</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.product-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

function exportProducts() {
    // Implement export functionality
    alert('Export functionality would be implemented here');
}

function showBulkActions() {
    const selectedProducts = document.querySelectorAll('.product-checkbox:checked');
    if (selectedProducts.length === 0) {
        alert('Please select products to perform bulk actions');
        return;
    }
    
    // Add selected product IDs to form
    const form = document.querySelector('#bulkActionsModal form');
    const existingInputs = form.querySelectorAll('input[name="product_ids"]');
    existingInputs.forEach(input => input.remove());
    
    selectedProducts.forEach(checkbox => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'product_ids';
        input.value = checkbox.value;
        form.appendChild(input);
    });
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('bulkActionsModal'));
    modal.show();
}

function toggleBulkFields() {
    const action = document.getElementById('bulkAction').value;
    const stockField = document.getElementById('stockField');
    const priceField = document.getElementById('priceField');
    const deleteWarning = document.getElementById('deleteWarning');
    
    // Hide all fields
    stockField.style.display = 'none';
    priceField.style.display = 'none';
    deleteWarning.style.display = 'none';
    
    // Show relevant field
    if (action === 'update_stock') {
        stockField.style.display = 'block';
    } else if (action === 'update_price') {
        priceField.style.display = 'block';
    } else if (action === 'delete') {
        deleteWarning.style.display = 'block';
    }
}

// Force apply statistics card styles immediately
document.addEventListener('DOMContentLoaded', function() {
    // Force apply styles to statistics cards
    const statsCards = document.querySelectorAll('.stats-card');
    statsCards.forEach((card, index) => {
        // Force background colors
        const colors = [
            'linear-gradient(135deg, #007bff, #0056b3)',
            'linear-gradient(135deg, #ffc107, #e0a800)', 
            'linear-gradient(135deg, #dc3545, #c82333)',
            'linear-gradient(135deg, #28a745, #1e7e34)'
        ];
        
        card.style.background = colors[index] + ' !important';
        card.style.border = 'none !important';
        card.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1) !important';
        
        // Force white text on all elements
        const textElements = card.querySelectorAll('h4, p, i, .stats-icon, .stats-number, .stats-label');
        textElements.forEach(element => {
            element.style.color = '#ffffff !important';
            element.style.textShadow = '0 1px 2px rgba(0, 0, 0, 0.3) !important';
        });
        
        // Force card body background to be transparent
        const cardBody = card.querySelector('.card-body');
        if (cardBody) {
            cardBody.style.background = 'transparent !important';
        }
    });
});
</script>

<style>
/* Statistics Cards - Force proper contrast and visibility with high specificity */
.container .row .col-6 .col-md-3 .stats-card,
.container .row .col-6 .col-md-3 .stats-card.card {
    border: none !important;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1) !important;
    transition: transform 0.2s ease, box-shadow 0.2s ease !important;
    background: #007bff !important;
}

.container .row .col-6 .col-md-3 .stats-card:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15) !important;
}

.container .row .col-6 .col-md-3 .stats-card .card-body {
    padding: 1.5rem !important;
    background: transparent !important;
}

/* Force white text on all stats cards with maximum specificity */
.container .row .col-6 .col-md-3 .stats-card .stats-icon,
.container .row .col-6 .col-md-3 .stats-card .stats-number,
.container .row .col-6 .col-md-3 .stats-card .stats-label,
.container .row .col-6 .col-md-3 .stats-card h4,
.container .row .col-6 .col-md-3 .stats-card p,
.container .row .col-6 .col-md-3 .stats-card i {
    color: #ffffff !important;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
    font-weight: 600 !important;
}

/* Specific color adjustments for each card type */
.container .row .col-6 .col-md-3:first-child .stats-card.bg-primary,
.container .row .col-6 .col-md-3:first-child .stats-card {
    background: linear-gradient(135deg, #007bff, #0056b3) !important;
}

.container .row .col-6 .col-md-3:nth-child(2) .stats-card.bg-warning,
.container .row .col-6 .col-md-3:nth-child(2) .stats-card {
    background: linear-gradient(135deg, #ffc107, #e0a800) !important;
}

.container .row .col-6 .col-md-3:nth-child(3) .stats-card.bg-danger,
.container .row .col-6 .col-md-3:nth-child(3) .stats-card {
    background: linear-gradient(135deg, #dc3545, #c82333) !important;
}

.container .row .col-6 .col-md-3:nth-child(4) .stats-card.bg-success,
.container .row .col-6 .col-md-3:nth-child(4) .stats-card {
    background: linear-gradient(135deg, #28a745, #1e7e34) !important;
}

/* Typography with high specificity */
.container .row .col-6 .col-md-3 .stats-card .stats-number {
    font-size: 2rem !important;
    font-weight: 700 !important;
    margin-bottom: 0.5rem !important;
    color: #ffffff !important;
}

.container .row .col-6 .col-md-3 .stats-card .stats-label {
    font-size: 0.875rem !important;
    opacity: 0.9 !important;
    font-weight: 500 !important;
    color: #ffffff !important;
}

.container .row .col-6 .col-md-3 .stats-card .stats-icon {
    color: #ffffff !important;
    font-size: 2rem !important;
}

/* Ensure proper color display with high specificity */
.stats-card.bg-primary {
    background: linear-gradient(135deg, #007bff, #0056b3) !important;
    color: #ffffff !important;
}

.stats-card.bg-warning {
    background: linear-gradient(135deg, #ffc107, #e0a800) !important;
    color: #ffffff !important;
}

.stats-card.bg-danger {
    background: linear-gradient(135deg, #dc3545, #c82333) !important;
    color: #ffffff !important;
}

.stats-card.bg-success {
    background: linear-gradient(135deg, #28a745, #1e7e34) !important;
    color: #ffffff !important;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .container .row .col-6 .col-md-3 .stats-card .card-body {
        padding: 1rem !important;
    }
    
    .container .row .col-6 .col-md-3 .stats-card .stats-number {
        font-size: 1.5rem !important;
    }
    
    .container .row .col-6 .col-md-3 .stats-card .stats-icon {
        font-size: 1.5rem !important;
    }
}
</style>
{% endblock %}